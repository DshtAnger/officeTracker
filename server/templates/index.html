{% load static %}
<html>
<head>
    <meta charset="utf-8">
    <title>云鼎文档溯源系统</title>
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}">
    <link rel="stylesheet" href="{% static 'css/semantic.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/index.css' %}">
    <script src="{% static 'js/jquery.min.js' %}"></script>
    <script src="{% static 'js/semantic.min.js' %}"></script>
{#    <script src="https://semantic-ui.com/javascript/library/tablesort.js"></script>#}
</head>

<body>
    <div class="ui fixed inverted main menu" id="top">
      <div class="fluid large ui black button" id='uid'>{{ user_id }}</div>
      <div class="fluid large ui black button">云鼎文档溯源系统</div>
      <div class="fluid large ui black button" onclick="window.location.href='/logout'">Logout</div>
    </div>

    <div class="fluid black ui buttons">
      <div class="ui button"></div>
      <div class="ui button"></div>
      <div class="ui button">
        <b>云鼎文档溯源系统</b>
      </div>
    </div>

    <div class="ui segment" id="wrapper">


        <input type="file" id="upload_file" accept=".docx, .pptx, .xlsx, .doc, .ppt, .xls" style='display:none' multiple="multiple"/>
{#        <input type="file" id="upload_file" accept=".docx, .xlsx, .doc, .xls" style='display:none' multiple="multiple"/>#}

        <div class="ui compact segment" style="margin:auto;">


{#            <form enctype="multipart/form-data" name="upload_form" action="/upload/" method="post">#}
{#             {% csrf_token %}#}
{#             <input type="file" name="upload_file" accept=".jpg, .jpeg, .png" onchange="document.forms['upload_form'].submit();"/>#}
{#            </form>#}


            <div id="container">

                <h3 style="text-align:center;margin: 15px;color: rgb(143, 143, 143);">Drag File Here</h3>

                <div id="drop-zone" style="margin:auto;">

                    <svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg"  style="margin: 5em 0em 0em 19em;">
                        <path class="icon-path" d="M2.09375 19.5H6.25C6.57656 19.5 6.84375 19.2328 6.84375 18.9062V5.84375H19.9062C20.2328 5.84375 20.5 5.57656 20.5 5.25V1.09375C20.5 0.767188 20.2328 0.5 19.9062 0.5H6.54688C3.75625 0.5 1.5 2.75625 1.5 5.54688V18.9062C1.5 19.2328 1.76719 19.5 2.09375 19.5ZM40.0938 5.84375H53.1562V18.9062C53.1562 19.2328 53.4234 19.5 53.75 19.5H57.9062C58.2328 19.5 58.5 19.2328 58.5 18.9062V5.54688C58.5 2.75625 56.2438 0.5 53.4531 0.5H40.0938C39.7672 0.5 39.5 0.767188 39.5 1.09375V5.25C39.5 5.57656 39.7672 5.84375 40.0938 5.84375ZM19.9062 52.1562H6.84375V39.0938C6.84375 38.7672 6.57656 38.5 6.25 38.5H2.09375C1.76719 38.5 1.5 38.7672 1.5 39.0938V52.4531C1.5 55.2438 3.75625 57.5 6.54688 57.5H19.9062C20.2328 57.5 20.5 57.2328 20.5 56.9062V52.75C20.5 52.4234 20.2328 52.1562 19.9062 52.1562ZM57.9062 38.5H53.75C53.4234 38.5 53.1562 38.7672 53.1562 39.0938V52.1562H40.0938C39.7672 52.1562 39.5 52.4234 39.5 52.75V56.9062C39.5 57.2328 39.7672 57.5 40.0938 57.5H53.4531C56.2438 57.5 58.5 55.2438 58.5 52.4531V39.0938C58.5 38.7672 58.2328 38.5 57.9062 38.5ZM59.0938 26.3281H0.90625C0.579688 26.3281 0.3125 26.5953 0.3125 26.9219V31.0781C0.3125 31.4047 0.579688 31.6719 0.90625 31.6719H59.0938C59.4203 31.6719 59.6875 31.4047 59.6875 31.0781V26.9219C59.6875 26.5953 59.4203 26.3281 59.0938 26.3281Z" fill="#F0F0F0"></path>
                    </svg>

                </div>

{#                <div id="content">#}
{#                    Your image to appear here..#}
{#                </div>#}

                <div style="text-align:center;margin: 3em 0px 0em 0em;">
                    <div class="ui search selection dropdown multiple">
                        <input type="hidden" id="multi-select">
                        <i class="dropdown icon"></i>
                        <div class="default text" >文档共享人</div>
                        <div class="menu transition hidden" tabindex="-1">
{#                            <div class="item selected" data-value="{{ user_id }}">{{ user_id }}</div>#}
                            {% for one_data in user_data %}
                                <div class="item" data-value="{{ one_data }}">{{ one_data }}</div>
                            {% endfor %}
                        </div>
                    </div>
                    <script>
                        $('.ui.selection.dropdown').dropdown();
                    </script>
                </div>

                <div style="text-align:center;margin: 2em 0em -2em 0em">
{#                    <button class="ui primary button">#}
{#                        <span>Upload Files</span>#}
{#                    </button>#}
                    <button class="ui blue button" onclick="document.getElementById('upload_file').click();">Upload Files</button>

                </div>

                <div id="feedback" style="padding: 15px;"></div>

{#                <label id="progress-label" for="progress"></label>#}
{#                <progress id="progress" value="0" max="100"></progress>#}

            </div>

            <style>
                div#container {
                  margin: 15px;
                }

                div#drop-zone {
                  height: 200px;
                  width: 600px;
                  border: 2px dotted #ebebeb;
                }

                div#drop-zone:hover {
                  background-color: rgba(143, 143, 143, 0.1);
                  border: 1px dotted #000000;
                  cursor: move;
                }

                div#content {

                  border: 1px solid #FFF;
                  margin-top: 15px;
                  padding: 10px;
                }


                .ui.blue.button {
                    width: 178px;
                    height: 48px;
                    margin-top: 10px;
                    background: rgb(255, 255, 255);
                    border: 1px solid rgb(0, 110, 255);
                    box-sizing: border-box;
                    border-radius: 8px;
                    color: rgb(0, 110, 255);
                    font-style: normal;
                    font-weight: normal;
                    font-size: 18px;
            }

            </style>

            <script>

                const Extension_list = ["doc", "docx", "ppt", "pptx", "xls", "xlsx"];

                function returnFileSize(number) {
                    if(number < 1024) {
                        return number + 'bytes';
                      } else if(number >= 1024 && number < 1048576) {
                        return (number/1024).toFixed(2) + 'KB';
                      } else if(number >= 1048576) {
                        return (number/1048576).toFixed(2) + 'MB';
                      }
                }

                function checkFile(){
                    // 获取文件对象(该对象的类型是[object FileList]，其下有个length属性)
                    var fileList = $('#upload_file')[0].files;

                    // 如果文件对象的length属性为0，就是没文件
                    if (fileList.length === 0) {
                        console.log('没选择文件');
                        return false;
                    }
                    else {
                        console.log('选择了文件');
                    }
                    return fileList;
                };

                const fileUploader = document.getElementById('upload_file');
                const feedback = document.getElementById('feedback');
                const dropZone = document.getElementById('drop-zone');
                const progress = document.getElementById('progress');
                //const content = document.getElementById('content');


                //拖拽及预览控件
                const reader = new FileReader();
                if (window.FileList && window.File) {

                    //拖拽功能

                  dropZone.addEventListener('dragover', event => {
                    event.stopPropagation();
                    event.preventDefault();
                    event.dataTransfer.dropEffect = 'copy';
                  });

                  dropZone.addEventListener('drop', event => {
                    //content.innerHTML = '';
                    event.stopPropagation();
                    event.preventDefault();

                    const files = event.dataTransfer.files;


                    //预览功能
                      /*
                    reader.readAsDataURL(files[0]);
                    reader.addEventListener('load', (event) => {
                      content.innerHTML = '';
                      const img = document.createElement('img');
                      img.style.height = '400px';
                      img.style.width = '400px';
                      content.appendChild(img);
                      img.src = event.target.result;
                      img.alt = file.name;

                    });*/

                    var formFile = new FormData();

                    for (var index=0;index < files.length;index++)
                    {
                        const filename = files[index].name;
                        var file_extension = filename.substring(filename.indexOf('.') + 1)
                        if ( Extension_list.indexOf(file_extension) == -1 )
                        {
                            alert('上传文件非法,请上传Office文档类型文件.');
                            return
                        }
                        formFile.append("file[]", files[index]);
                    }

                    var file_sharer = $("#multi-select").val()
                    formFile.append('file_sharer', file_sharer)

                    $.ajax({
                        url: "/upload/",
                        data: formFile,
                        type: "POST",
                        cache: false,			//上传文件无需缓存
                        processData: false,		//用于对data参数进行序列化处理 这里必须false
                        contentType: false, 	//必须
                        success: function(result){
                            //alert(result);
                            if (result.slice(0,4) == '[OK]')
                                location.reload(true);
                            else
                                alert(result)
                        },
                        error: function(result){
                            alert('上传失败'+'|'+'未捕获异常'+result);
                        }
                    });

                  });
                }

                //按钮文件上传
                fileUploader.addEventListener('change', (event) => {

                    var fileList = event.target.files;

                    var formFile = new FormData();

                    for (var index=0;index < fileList.length;index++)
                    {
                        formFile.append("file[]", fileList[index]);
                    }

                    var file_sharer = $("#multi-select").val()

                    var data = {

                    }
                    formFile.append('file_sharer', file_sharer)

                    $.ajax({
                        url: "/upload/",
                        data: formFile,
                        type: "POST",
                        cache: false,			//上传文件无需缓存
                        processData: false,		//用于对data参数进行序列化处理 这里必须false
                        contentType: false, 	//必须
                        success: function(result){
                            //alert(result);
                            if (result.slice(0,4) == '[OK]')
                                location.reload(true);
                            else
                                alert(result)
                        },
                        error: function(result){
                            alert('上传失败'+'|'+'未捕获异常'+result);
                        }
                    });


                    /*
                    const file = event.target.files[0];
                  //进度控件
                  reader.readAsDataURL(file);
                  reader.addEventListener('progress', (event) => {
                    if (event.loaded && event.total) {
                      const percent = (event.loaded / event.total) * 100;
                      progress.value = percent;
                      document.getElementById('progress-label').innerHTML = file.name + ' ' + Math.round(percent) + '%';

                      if (percent === 100) {
                        let msg = `<span style="color:green;">File <u><b>${file.name}</b></u> has been uploaded successfully.</span>`;
                        feedback.innerHTML = msg;
                      }
                    }
                  });
                    /*

                  //文件大小检测控件
                  const size = file.size;
                  let msg = '';
                  if (size > 1024 * 1024) {
                    msg = `<span style="color:red;">The allowed file size is 1MB. The file you are trying to upload is of ${returnFileSize(size)}</span>`;
                  } else {
                    msg = `<span style="color:green;"> A ${returnFileSize(size)} file has been uploaded successfully. </span>`;
                  };
                  feedback.innerHTML = msg;*/
                });

            </script>

        </div>

        <div id="data_show" style="margin-top: 2em;">

            <table class="ui sortable celled green table" id="main_table">

              <thead>
                <tr class="center aligned">
                    <th>文件名</th>
                    <th class="one wide">文件大小</th>
                    <th class="three wide">文件Hash</th>
                    <th>归属人</th>
                    <th>共享人</th>
                    <th class="one wide">上传时间</th>
                    <th class="one wide">上传IP</th>
                    <th class="one wide">下载链接</th>
                    <th >访问记录</th>
                </tr>
              </thead>

              <tbody>

                  <tr style="display:none"><td ></td><td ></td><td ></td><td ></td><td ></td><td ></td><td ></td></tr>

                  {% for one_data in file_data %}
                      <tr class="center aligned">
                        <td >{{ one_data.file_name }}</td>
                        <td >{{ one_data.file_size }}</td>
                        <td >{{ one_data.file_hash }}</td>
                        <td >{{ one_data.file_owner }}</td>
                        <td id="sharer_{{ one_data.file_watermark }}">{{ one_data.file_sharer }}</td>
                        <td >{{ one_data.upload_time }}</td>
                        <td >{{ one_data.upload_ip }}</td>
                        <td >
                            <div class="ui inverted small icon buttons" id="download_link_{{ one_data.file_watermark }}">
                                {% if one_data.download_file_path == 'None' %}
                                <div></div>
                                {% elif one_data.download_file_path %}
                                <button class="ui inverted basic button">
                                    <a href="/download/{{ one_data.file_watermark }}">
                                        <img src="{% static 'images/download.png' %}" alt="download">
                                    </a>
                                </button>
                                {% else %}
                                <button class="ui inverted basic loading button" id="load_button_{{ one_data.file_watermark }}"></button>
                                {% endif %}
                            </div>
                        </td>

                        <td >
                            <table class="ui very basic table">
                                    <tbody id="{{ one_data.file_watermark }}">

                                    {% for track in one_data.track %}
                                    <tr class="center aligned">
                                      <td>{{ track.access_time }}</td>
                                      <td>{{ track.access_ip }}</td>
                                    </tr>
                                    {% endfor %}

                                    </tbody>
                            </table>
                        </td>
                      </tr>
                  {% endfor %}

              </tbody>

            </table>

        </div>

        <script>

         //$('#main_table').tablesort();

        const user_id = document.getElementById('uid').textContent;

        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/'
            + user_id
            + '/'
        );

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            //alert(data + '\n');
            if (data.download_update){
                //console.log('download_update');

                var load_button = document.getElementById('load_button'+'_'+data.download_update);

                if (load_button == null)
                    location.reload(true);
                else
                    load_button.remove();

                //const sharer = document.getElementById('sharer' + '_' + data.download_update)

                var download_link = document.getElementById('download_link'+'_'+data.download_update);

                var download_button = document.createElement('button');
                download_button.setAttribute('class', 'ui inverted basic button');
                //download_button.setAttribute('id', 'download_button');
                download_button.innerHTML = '<a href="/download/' + data.download_update + '"><img src="/static/images/download.png" alt="download"></a>';

                download_link.append(download_button);

            }

            else if (data.track_update){

                //console.log('track_update');

                var tbody_obj = document.getElementById(data.track_update);

                var tr_obj = document.createElement('tr');
                tr_obj.setAttribute('class','center aligned');
                tr_obj.innerHTML = '<td>' + data.access_time + '</td><td>' + data.access_ip + '</td>'

                tbody_obj.prepend(tr_obj);
            }
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

    </script>

    </div>
</body>
</html>
